#!/usr/bin/env bash
set -euo pipefail

MODE_FILE="${HOME}/.config/boo/mode.zsh"
THEME_FILE="${HOME}/.config/boo/theme"
THEME_ENV_FILE="${HOME}/.config/boo/theme.zsh"
PROMPT_FILE="${HOME}/.config/boo/prompt"
SPLASH_FILE="${HOME}/.config/boo/splash.zsh"
CUSTOM_SPLASH_FILE="${HOME}/.config/boo/custom-splash.txt"
BUILTIN_ART_DIR="${HOME}/.config/boo/art"
DEFAULT_SPLASH="apple"
CONFIG_DIR="${HOME}/.config/boo"
SHELL_SNIPPET_FILE="${HOME}/.config/boo/boo.zsh"
ZSHRC_FILE="${HOME}/.zshrc"
LOCAL_BIN_DIR="${HOME}/.local/bin"
LOCAL_BIN_FILE="${HOME}/.local/bin/boo"
BOO_BLOCK_START="# >>> Boo >>>"
BOO_BLOCK_END="# <<< Boo <<<"
LEGACY_BLOCK_START="# >>> ObsiGhost >>>"
LEGACY_BLOCK_END="# <<< ObsiGhost <<<"
GHOSTTY_CONFIG_PRIMARY="${HOME}/.config/ghostty/config"
GHOSTTY_CONFIG_MAC="${HOME}/Library/Application Support/com.mitchellh.ghostty/config"
OMP_ACTIVE_CONFIG="${HOME}/.config/ohmyposh/boo.omp.json"
OMP_PRESET_DIR="${HOME}/.config/boo/ohmyposh"
DEFAULT_OPACITY="0.92"
DEFAULT_THEME="obsidian"
DEFAULT_PROMPT_BACKEND="native"
UNAME_S="$(uname -s)"
UNSAFE_RELOAD_REASON=""

ghostty_targets=()

print_help() {
  cat <<'EOF'
Boo CLI

Usage:
  boo mode [full|public]
  boo prompt [show|list|set <native|omp>|native|omp]
  boo theme [list|set <name>|<name>]
  boo opacity [value|glass|solid]
  boo preview [<theme>|all] [--plain]
  boo splash [list|<name>|custom <file>|none|reset]
  boo doctor [check|fix]
  boo reload [--unsafe]
  boo status
  boo help

Commands:
  mode       Show or set startup panel mode.
  prompt     Show or set shell prompt backend.
  theme      List or apply full terminal/prompt presets.
  opacity    Show or set Ghostty background opacity.
  preview    Preview one theme or all themes (ANSI swatches or plain hex).
  splash     Configure startup splash art (built-in/custom/none/reset).
  doctor     Diagnose and optionally fix common setup issues.
  reload     No new windows. Use --unsafe to send Cmd+Shift+, to Ghostty.
  status     Print current mode/theme/prompt/opacity.
  help       Show this help message.
EOF
}

read_mode() {
  if [[ -f "$MODE_FILE" ]]; then
    if grep -q 'BOO_SHOW_PRIVATE=0' "$MODE_FILE"; then
      printf 'public\n'
      return
    fi
    if grep -q 'BOO_SHOW_PRIVATE=1' "$MODE_FILE"; then
      printf 'full\n'
      return
    fi
  fi
  if [[ "${BOO_SHOW_PRIVATE:-}" == "0" ]]; then
    printf 'public\n'
  else
    printf 'full\n'
  fi
}

write_mode_file() {
  local value="$1"
  mkdir -p "$(dirname "$MODE_FILE")"
  printf 'export BOO_SHOW_PRIVATE=%s\n' "$value" > "$MODE_FILE"
}

read_theme_file() {
  local theme
  if [[ -f "$THEME_FILE" ]]; then
    theme="$(tr -d '[:space:]' < "$THEME_FILE")"
    if [[ -n "$theme" ]]; then
      printf '%s\n' "$theme"
      return
    fi
  fi
  printf '%s\n' "$DEFAULT_THEME"
}

write_theme_file() {
  local theme="$1"
  mkdir -p "$(dirname "$THEME_FILE")"
  printf '%s\n' "$theme" > "$THEME_FILE"
}

read_prompt_backend() {
  local backend
  if [[ -f "$PROMPT_FILE" ]]; then
    backend="$(tr -d '[:space:]' < "$PROMPT_FILE" | tr '[:upper:]' '[:lower:]')"
    case "$backend" in
      native|omp)
        printf '%s\n' "$backend"
        return
        ;;
      *)
        ;;
    esac
  fi
  printf '%s\n' "$DEFAULT_PROMPT_BACKEND"
}

write_prompt_backend() {
  local backend="$1"
  mkdir -p "$(dirname "$PROMPT_FILE")"
  printf '%s\n' "$backend" > "$PROMPT_FILE"
}

read_splash_name() {
  local splash
  if [[ -f "$SPLASH_FILE" ]]; then
    splash="$(grep -E '^export BOO_SPLASH=' "$SPLASH_FILE" | head -n1 | cut -d'=' -f2- | tr -d '"' | tr -d "'" | tr -d '[:space:]')"
    if [[ -n "$splash" ]]; then
      printf '%s\n' "$splash"
      return
    fi
  fi
  printf '%s\n' "$DEFAULT_SPLASH"
}

write_splash_name() {
  local splash="$1"
  mkdir -p "$(dirname "$SPLASH_FILE")"
  printf 'export BOO_SPLASH="%s"\n' "$splash" > "$SPLASH_FILE"
}

list_splash_names() {
  printf '%s\n' apple ghost skull cat minimal boo
}

print_splash_preview() {
  local splash="$1"
  local source_file="${BUILTIN_ART_DIR}/${splash}.txt"

  if [[ "$splash" == "minimal" ]]; then
    printf '  (no ASCII art, info panel only)\n'
    return
  fi

  if [[ -f "$source_file" ]]; then
    head -n 3 "$source_file" | sed 's/^/  /'
    return
  fi

  printf '  (preview unavailable: %s)\n' "$source_file"
}

effective_prompt_backend() {
  local configured
  configured="$(read_prompt_backend)"
  if [[ "$configured" == "omp" ]] && ! command -v oh-my-posh >/dev/null 2>&1; then
    printf 'native\n'
    return
  fi
  printf '%s\n' "$configured"
}

print_command_box() {
  local cmd="$1"
  local pad=1
  local width=$(( ${#cmd} + (pad * 2) ))
  local border
  border="$(printf '%*s' "$width" '' | tr ' ' '─')"
  printf '┌%s┐\n' "$border"
  printf '│%*s%s%*s│\n' "$pad" '' "$cmd" "$pad" ''
  printf '└%s┘\n' "$border"
}

print_shell_apply_hint() {
  if [[ "${BOO_SHELL_WRAPPER:-0}" == "1" ]]; then
    printf 'Applied in current shell.\n'
    return
  fi
  printf 'To apply now in this shell, run:\n'
  print_command_box "exec zsh"
}

doctor_ok_count=0
doctor_warn_count=0
doctor_fail_count=0

doctor_reset_counts() {
  doctor_ok_count=0
  doctor_warn_count=0
  doctor_fail_count=0
}

doctor_line() {
  local level="$1"
  local title="$2"
  local detail="${3:-}"
  local tag

  case "$level" in
    ok)
      tag="[ok]"
      doctor_ok_count=$((doctor_ok_count + 1))
      ;;
    warn)
      tag="[warn]"
      doctor_warn_count=$((doctor_warn_count + 1))
      ;;
    fail)
      tag="[fail]"
      doctor_fail_count=$((doctor_fail_count + 1))
      ;;
    *)
      tag="[info]"
      ;;
  esac

  printf '%-7s %s\n' "$tag" "$title"
  if [[ -n "$detail" ]]; then
    printf '        %s\n' "$detail"
  fi
}

doctor_has_zshrc_boo_block() {
  if [[ ! -f "$ZSHRC_FILE" ]]; then
    return 1
  fi
  grep -qF "$BOO_BLOCK_START" "$ZSHRC_FILE" && grep -qF "$BOO_BLOCK_END" "$ZSHRC_FILE"
}

doctor_path_has_local_bin() {
  case ":${PATH}:" in
    *":${LOCAL_BIN_DIR}:"*) return 0 ;;
    *) return 1 ;;
  esac
}

doctor_file_hash() {
  local file="$1"
  if command -v shasum >/dev/null 2>&1; then
    shasum -a 256 "$file" | awk '{print $1}'
    return
  fi
  cksum "$file" | awk '{print $1 "-" $2}'
}

doctor_clean_legacy_marked_block() {
  local file="$1"
  local tmp
  tmp="$(mktemp)"
  awk -v start="$LEGACY_BLOCK_START" -v end="$LEGACY_BLOCK_END" '
    $0 ~ start { skip = 1; next }
    $0 ~ end { skip = 0; next }
    skip != 1 { print }
  ' "$file" > "$tmp"
  mv "$tmp" "$file"
}

doctor_remove_obsighost_lines() {
  local file="$1"
  local tmp
  tmp="$(mktemp)"
  awk '
    /obsighost\.omp\.json/ { next }
    /source .*\.config\/obsighost\/obsighost\.zsh/ { next }
    /^obsighost_apply_highlight_colors$/ { next }
    { print }
  ' "$file" > "$tmp"
  mv "$tmp" "$file"
}

doctor_ensure_zshrc_path_and_block() {
  if [[ ! -f "$ZSHRC_FILE" ]]; then
    touch "$ZSHRC_FILE"
  fi

  if ! grep -q 'PATH=.*\.local/bin' "$ZSHRC_FILE"; then
    cat >> "$ZSHRC_FILE" <<'EOF'

export PATH="$HOME/.local/bin:$PATH"
EOF
  fi

  if ! doctor_has_zshrc_boo_block; then
    cat >> "$ZSHRC_FILE" <<'EOF'

# >>> Boo >>>
if [[ -f "$HOME/.config/boo/boo.zsh" ]]; then
  source "$HOME/.config/boo/boo.zsh"
fi
# <<< Boo <<<
EOF
  fi
}

doctor_apply_fixes() {
  local self_bin
  local script_dir script_root snippet_source
  local old_backend

  printf 'Applying safe fixes...\n'
  mkdir -p "$CONFIG_DIR" "$LOCAL_BIN_DIR"

  doctor_ensure_zshrc_path_and_block

  if [[ -f "$ZSHRC_FILE" ]]; then
    doctor_clean_legacy_marked_block "$ZSHRC_FILE"
    doctor_remove_obsighost_lines "$ZSHRC_FILE"
  fi

  if [[ ! -f "$PROMPT_FILE" ]]; then
    printf '%s\n' "$DEFAULT_PROMPT_BACKEND" > "$PROMPT_FILE"
  fi

  if [[ ! -f "$THEME_ENV_FILE" ]]; then
    cat > "$THEME_ENV_FILE" <<'EOF'
export BOO_THEME="obsidian"
export BOO_ACCENT_COLOR="#a882ff"
export BOO_PANEL_COLOR_RGB="168;130;255"
EOF
  fi

  old_backend="$(read_prompt_backend)"
  if [[ "$old_backend" == "omp" ]] && ! command -v oh-my-posh >/dev/null 2>&1; then
    write_prompt_backend "native"
  fi

  script_dir="$(cd "$(dirname "$0")" && pwd)"
  script_root="$(cd "$script_dir/.." && pwd)"
  snippet_source="${script_root}/shell/boo.zsh"
  if [[ ! -f "$SHELL_SNIPPET_FILE" && -f "$snippet_source" ]]; then
    cp "$snippet_source" "$SHELL_SNIPPET_FILE"
  fi

  self_bin="$(cd "$(dirname "$0")" && pwd)/$(basename "$0")"
  if [[ -f "$self_bin" ]]; then
    cp "$self_bin" "$LOCAL_BIN_FILE"
    chmod +x "$LOCAL_BIN_FILE"
  fi
}

doctor_run_checks() {
  local configured_backend effective_backend
  local command_path
  local local_hash mac_hash
  local refs

  doctor_reset_counts
  printf 'Boo doctor report\n'
  printf '%s\n' '-----------------'

  if [[ -x "$LOCAL_BIN_FILE" ]]; then
    doctor_line ok "CLI binary exists" "$LOCAL_BIN_FILE"
  else
    doctor_line fail "CLI binary missing/executable bit not set" "$LOCAL_BIN_FILE"
  fi

  command_path="$(command -v boo 2>/dev/null || true)"
  if [[ -n "$command_path" ]]; then
    doctor_line ok "boo resolves in PATH" "$command_path"
  else
    doctor_line warn "boo command not found in current PATH" "Run: exec zsh (or add $LOCAL_BIN_DIR to PATH)."
  fi

  if doctor_path_has_local_bin; then
    doctor_line ok "PATH contains ~/.local/bin"
  else
    doctor_line warn "PATH missing ~/.local/bin in current shell"
  fi

  if [[ -f "$SHELL_SNIPPET_FILE" ]]; then
    doctor_line ok "Shell snippet exists" "$SHELL_SNIPPET_FILE"
  else
    doctor_line warn "Shell snippet missing" "$SHELL_SNIPPET_FILE"
  fi

  if doctor_has_zshrc_boo_block; then
    doctor_line ok "Boo source block present in ~/.zshrc"
  else
    doctor_line warn "Boo source block missing in ~/.zshrc" "Run: boo doctor fix"
  fi

  refs="$(grep -nE 'obsighost|\.config/obsighost' "$ZSHRC_FILE" 2>/dev/null || true)"
  if [[ -n "$refs" ]]; then
    doctor_line warn "Legacy obsighost references found in ~/.zshrc" "Run: boo doctor fix"
  else
    doctor_line ok "No legacy obsighost references in ~/.zshrc"
  fi

  configured_backend="$(read_prompt_backend)"
  effective_backend="$(effective_prompt_backend)"
  doctor_line ok "Prompt backend" "configured=${configured_backend}, active=${effective_backend}"
  if [[ "$configured_backend" == "omp" && "$effective_backend" == "native" ]]; then
    doctor_line warn "oh-my-posh missing while prompt backend is omp" "Install oh-my-posh or run: boo prompt set native"
  fi

  if [[ -s "$GHOSTTY_CONFIG_PRIMARY" && -s "$GHOSTTY_CONFIG_MAC" ]]; then
    local_hash="$(doctor_file_hash "$GHOSTTY_CONFIG_PRIMARY")"
    mac_hash="$(doctor_file_hash "$GHOSTTY_CONFIG_MAC")"
    if [[ "$local_hash" != "$mac_hash" ]]; then
      doctor_line warn "Ghostty config mismatch across two locations" "$GHOSTTY_CONFIG_PRIMARY and $GHOSTTY_CONFIG_MAC differ."
    else
      doctor_line ok "Ghostty config mirrored in both locations"
    fi
  else
    doctor_line ok "Ghostty config path setup has no split conflict"
  fi

  printf '\nSummary: ok=%d warn=%d fail=%d\n' "$doctor_ok_count" "$doctor_warn_count" "$doctor_fail_count"
  if (( doctor_fail_count > 0 )); then
    return 1
  fi
  return 0
}

theme_accent_color() {
  local theme="$1"
  case "$theme" in
    obsidian) printf '#a882ff\n' ;;
    graphite) printf '#b7a2ff\n' ;;
    lunar) printf '#7cc6ff\n' ;;
    crimson) printf '#ff4f7a\n' ;;
    matrix) printf '#39ff14\n' ;;
    *) printf '#a882ff\n' ;;
  esac
}

theme_panel_rgb() {
  local theme="$1"
  case "$theme" in
    obsidian) printf '168;130;255\n' ;;
    graphite) printf '183;162;255\n' ;;
    lunar) printf '124;198;255\n' ;;
    crimson) printf '255;79;122\n' ;;
    matrix) printf '57;255;20\n' ;;
    *) printf '168;130;255\n' ;;
  esac
}

theme_core_colors() {
  local theme="$1"
  case "$theme" in
    obsidian)
      cat <<'EOF'
bg=#0b0f0b
fg=#d8dde5
accent=#a882ff
cursor=#e8ecf2
selection=#262e38
EOF
      ;;
    graphite)
      cat <<'EOF'
bg=#0f1115
fg=#e6ebf2
accent=#b7a2ff
cursor=#f2f5fa
selection=#323a47
EOF
      ;;
    lunar)
      cat <<'EOF'
bg=#0a0f18
fg=#d9e2f2
accent=#7cc6ff
cursor=#f2f6ff
selection=#243247
EOF
      ;;
    crimson)
      cat <<'EOF'
bg=#120606
fg=#ffe4ea
accent=#ff4f7a
cursor=#fff3f6
selection=#3a121a
EOF
      ;;
    matrix)
      cat <<'EOF'
bg=#030803
fg=#caffd0
accent=#39ff14
cursor=#eaffef
selection=#103018
EOF
      ;;
    *)
      return 1
      ;;
  esac
}

hex_to_rgb() {
  local hex="${1#\#}"
  if [[ ! "$hex" =~ ^[0-9A-Fa-f]{6}$ ]]; then
    return 1
  fi
  printf '%d;%d;%d\n' "0x${hex:0:2}" "0x${hex:2:2}" "0x${hex:4:2}"
}

print_color_swatch_line() {
  local label="$1"
  local hex="$2"
  local rgb
  rgb="$(hex_to_rgb "$hex")" || return 1

  printf '  %-9s ' "$label"
  printf '\033[38;2;%s;48;2;%sm████\033[0m ' "$rgb" "$rgb"
  printf '\033[38;2;%sm%s\033[0m\n' "$rgb" "$hex"
}

print_color_plain_line() {
  local label="$1"
  local hex="$2"
  printf '  %-9s %s\n' "$label" "$hex"
}

print_theme_preview() {
  local theme="$1"
  local plain="${2:-0}"
  local line key value

  printf '%s\n' "$theme"
  while IFS= read -r line; do
    key="${line%%=*}"
    value="${line#*=}"
    if (( plain == 1 )); then
      print_color_plain_line "$key" "$value"
    else
      print_color_swatch_line "$key" "$value"
    fi
  done < <(theme_core_colors "$theme")
  printf '  Apply? boo theme %s\n' "$theme"
}

print_preview_all_row() {
  local theme="$1"
  local plain="${2:-0}"
  local line value rgb
  local key

  if (( plain == 1 )); then
    local bg="" fg="" accent="" cursor="" selection=""
    while IFS= read -r line; do
      key="${line%%=*}"
      value="${line#*=}"
      case "$key" in
        bg) bg="$value" ;;
        fg) fg="$value" ;;
        accent) accent="$value" ;;
        cursor) cursor="$value" ;;
        selection) selection="$value" ;;
      esac
    done < <(theme_core_colors "$theme")
    printf '%-10s bg=%s fg=%s accent=%s cursor=%s selection=%s boo theme %s\n' \
      "$theme" "$bg" "$fg" "$accent" "$cursor" "$selection" "$theme"
    return
  fi

  printf '%-10s ' "$theme"
  while IFS= read -r line; do
    value="${line#*=}"
    rgb="$(hex_to_rgb "$value")" || return 1
    printf '\033[38;2;%s;48;2;%sm████\033[0m ' "$rgb" "$rgb"
  done < <(theme_core_colors "$theme")
  printf 'boo theme %s\n' "$theme"
}

write_theme_env_file() {
  local theme="$1"
  local accent panel
  accent="$(theme_accent_color "$theme")"
  panel="$(theme_panel_rgb "$theme")"

  mkdir -p "$(dirname "$THEME_ENV_FILE")"
  cat > "$THEME_ENV_FILE" <<EOF
export BOO_THEME="${theme}"
export BOO_ACCENT_COLOR="${accent}"
export BOO_PANEL_COLOR_RGB="${panel}"
EOF
}

apply_prompt_theme() {
  local theme="$1"
  local preset="${OMP_PRESET_DIR}/${theme}.omp.json"
  local tmp

  local accent chip_cloud_bg go_fg az_fg gcp_fg tf_fg sysinfo_fg git_bg
  case "$theme" in
    obsidian)
      accent="#a882ff"
      chip_cloud_bg="#2f2450"
      go_fg="#c5adff"
      az_fg="#a882ff"
      gcp_fg="#b79cff"
      tf_fg="#c4b5fd"
      sysinfo_fg="#cab6ff"
      git_bg="#3f2d59"
      ;;
    graphite)
      accent="#b7a2ff"
      chip_cloud_bg="#2b253f"
      go_fg="#cdbdff"
      az_fg="#b7a2ff"
      gcp_fg="#c7b7ff"
      tf_fg="#d2c6ff"
      sysinfo_fg="#cfbeff"
      git_bg="#3b2f52"
      ;;
    lunar)
      accent="#7cc6ff"
      chip_cloud_bg="#1f2d40"
      go_fg="#90d5ff"
      az_fg="#7cc6ff"
      gcp_fg="#8ed4ff"
      tf_fg="#9ad9ff"
      sysinfo_fg="#a3deff"
      git_bg="#2a3e57"
      ;;
    crimson)
      accent="#ff4f7a"
      chip_cloud_bg="#40131f"
      go_fg="#ff9ab0"
      az_fg="#ff4f7a"
      gcp_fg="#ff86a2"
      tf_fg="#ffb3c5"
      sysinfo_fg="#ff9db4"
      git_bg="#4f1b2a"
      ;;
    matrix)
      accent="#39ff14"
      chip_cloud_bg="#0e2a18"
      go_fg="#6bff73"
      az_fg="#39ff14"
      gcp_fg="#7bff8a"
      tf_fg="#9dff9a"
      sysinfo_fg="#83ffb3"
      git_bg="#13351e"
      ;;
    *)
      return 1
      ;;
  esac

  # Prefer in-place patching to preserve any user prompt customizations.
  if [[ -f "$OMP_ACTIVE_CONFIG" ]] && command -v jq >/dev/null 2>&1; then
    tmp="$(mktemp)"
    jq \
      --arg accent "$accent" \
      --arg chip_cloud_bg "$chip_cloud_bg" \
      --arg go_fg "$go_fg" \
      --arg az_fg "$az_fg" \
      --arg gcp_fg "$gcp_fg" \
      --arg tf_fg "$tf_fg" \
      --arg sysinfo_fg "$sysinfo_fg" \
      --arg git_bg "$git_bg" \
      '
      .palette.accent = $accent
      | .palette.chip_cloud_bg = $chip_cloud_bg
      | (.blocks[].segments[] | select(.type=="go")).foreground = $go_fg
      | (.blocks[].segments[] | select(.type=="az")).foreground = $az_fg
      | (.blocks[].segments[] | select(.type=="gcp")).foreground = $gcp_fg
      | (.blocks[].segments[] | select(.type=="terraform")).foreground = $tf_fg
      | (.blocks[].segments[] | select(.type=="sysinfo")).foreground = $sysinfo_fg
      | (.blocks[].segments[] | select(.type=="git").background_templates[1]) = $git_bg
      ' \
      "$OMP_ACTIVE_CONFIG" > "$tmp"
    mv "$tmp" "$OMP_ACTIVE_CONFIG"
    return 0
  fi

  if [[ -f "$preset" ]]; then
    mkdir -p "$(dirname "$OMP_ACTIVE_CONFIG")"
    cp "$preset" "$OMP_ACTIVE_CONFIG"
    return 0
  fi

  printf 'Prompt preset not found: %s\n' "$preset" >&2
  printf 'Run installer to install theme presets.\n' >&2
  return 1
}

collect_ghostty_targets() {
  ghostty_targets=()

  if [[ "$UNAME_S" == "Darwin" ]]; then
    # Prefer whichever config Ghostty is already using (non-empty file).
    if [[ -s "$GHOSTTY_CONFIG_MAC" ]]; then
      ghostty_targets+=("$GHOSTTY_CONFIG_MAC")
    fi
    if [[ -s "$GHOSTTY_CONFIG_PRIMARY" ]]; then
      ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
    fi

    if [[ "${#ghostty_targets[@]}" -eq 0 ]]; then
      if [[ -f "$GHOSTTY_CONFIG_MAC" ]]; then
        ghostty_targets+=("$GHOSTTY_CONFIG_MAC")
      elif [[ -f "$GHOSTTY_CONFIG_PRIMARY" ]]; then
        ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
      else
        mkdir -p "$(dirname "$GHOSTTY_CONFIG_PRIMARY")"
        touch "$GHOSTTY_CONFIG_PRIMARY"
        ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
      fi
    fi
    return
  fi

  mkdir -p "$(dirname "$GHOSTTY_CONFIG_PRIMARY")"
  if [[ ! -f "$GHOSTTY_CONFIG_PRIMARY" ]]; then
    touch "$GHOSTTY_CONFIG_PRIMARY"
  fi
  ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
}

upsert_key() {
  local file="$1"
  local key="$2"
  local value="$3"
  local tmp
  tmp="$(mktemp)"

  awk -v key="$key" -v value="$value" '
    BEGIN { re = "^[[:space:]]*" key "[[:space:]]*="; done = 0 }
    $0 ~ re {
      if (!done) {
        print key " = " value
        done = 1
      }
      next
    }
    { print }
    END {
      if (!done) {
        print key " = " value
      }
    }
  ' "$file" > "$tmp"

  mv "$tmp" "$file"
}

theme_palette_lines() {
  local theme="$1"
  case "$theme" in
    obsidian)
      cat <<'EOF'
palette = 0=#0b0f0b
palette = 1=#7a3b3b
palette = 2=#6fb56f
palette = 3=#a9a062
palette = 4=#5f7da3
palette = 5=#8b76a8
palette = 6=#5ea39a
palette = 7=#a8bfa8
palette = 8=#2a342a
palette = 9=#b35757
palette = 10=#8fdb8f
palette = 11=#d1c97b
palette = 12=#7ea4d1
palette = 13=#ac93cb
palette = 14=#7dc7be
palette = 15=#d9ead9
EOF
      ;;
    graphite)
      cat <<'EOF'
palette = 0=#0f1115
palette = 1=#6e7a88
palette = 2=#8493a5
palette = 3=#9ba8b8
palette = 4=#8f9fb3
palette = 5=#a882ff
palette = 6=#8caeb5
palette = 7=#d7dde7
palette = 8=#252a33
palette = 9=#7f8ea1
palette = 10=#97a8bd
palette = 11=#b2becd
palette = 12=#a2b2c8
palette = 13=#bba2ff
palette = 14=#a2c3c8
palette = 15=#f2f5f9
EOF
      ;;
    lunar)
      cat <<'EOF'
palette = 0=#0a0f18
palette = 1=#5f6f92
palette = 2=#6f86aa
palette = 3=#8c9ec0
palette = 4=#7891b7
palette = 5=#7cc6ff
palette = 6=#7ca9bb
palette = 7=#ced8e8
palette = 8=#1f2938
palette = 9=#7085ab
palette = 10=#83a0c2
palette = 11=#9fb4d0
palette = 12=#8ea8cc
palette = 13=#9edbff
palette = 14=#95c3cf
palette = 15=#eff4ff
EOF
      ;;
    crimson)
      cat <<'EOF'
palette = 0=#120606
palette = 1=#ff4d57
palette = 2=#d96b4d
palette = 3=#ff8a5b
palette = 4=#d45a6a
palette = 5=#ff2f4f
palette = 6=#ff6b8a
palette = 7=#f7d8dd
palette = 8=#2a0f12
palette = 9=#ff6b74
palette = 10=#f2876b
palette = 11=#ffb07a
palette = 12=#ff7f92
palette = 13=#ff9ab0
palette = 14=#ff8c9c
palette = 15=#fff1f3
EOF
      ;;
    matrix)
      cat <<'EOF'
palette = 0=#030803
palette = 1=#2bff6e
palette = 2=#39ff14
palette = 3=#8cff66
palette = 4=#00c853
palette = 5=#00ff9c
palette = 6=#00e676
palette = 7=#b8ffca
palette = 8=#0a1a0a
palette = 9=#55ff88
palette = 10=#74ff4f
palette = 11=#b5ff7a
palette = 12=#2aff9b
palette = 13=#66ffd9
palette = 14=#40ffb0
palette = 15=#e8ffe8
EOF
      ;;
    *)
      return 1
      ;;
  esac
}

replace_palette_lines() {
  local file="$1"
  local theme="$2"
  local tmp palette_tmp

  tmp="$(mktemp)"
  palette_tmp="$(mktemp)"
  theme_palette_lines "$theme" > "$palette_tmp"

  awk -v palette_file="$palette_tmp" '
    BEGIN { inserted = 0 }
    /^[[:space:]]*palette[[:space:]]*=/ { next }
    {
      print
      if (!inserted && $0 ~ /^[[:space:]]*selection-foreground[[:space:]]*=/) {
        while ((getline line < palette_file) > 0) {
          print line
        }
        close(palette_file)
        inserted = 1
      }
    }
    END {
      if (!inserted) {
        while ((getline line < palette_file) > 0) {
          print line
        }
        close(palette_file)
      }
    }
  ' "$file" > "$tmp"

  mv "$tmp" "$file"
  rm -f "$palette_tmp"
}

current_opacity() {
  collect_ghostty_targets
  local file line value
  for file in "${ghostty_targets[@]}"; do
    line="$(grep -m1 -E '^[[:space:]]*background-opacity[[:space:]]*=' "$file" || true)"
    if [[ -n "$line" ]]; then
      value="$(printf '%s\n' "$line" | sed -E 's/^[^=]+= *//; s/[[:space:]]+$//')"
      printf '%s\n' "$value"
      return
    fi
  done
  printf '%s\n' "$DEFAULT_OPACITY"
}

set_opacity_value() {
  local value="$1"
  local file

  collect_ghostty_targets
  for file in "${ghostty_targets[@]}"; do
    upsert_key "$file" "background-opacity" "$value"
  done
}

unsafe_reload_via_keystroke() {
  local result
  UNSAFE_RELOAD_REASON=""

  if [[ "$UNAME_S" != "Darwin" ]]; then
    UNSAFE_RELOAD_REASON="not-darwin"
    return 1
  fi
  if ! command -v osascript >/dev/null 2>&1; then
    UNSAFE_RELOAD_REASON="no-osascript"
    return 1
  fi

  result="$(osascript <<'APPLESCRIPT' 2>/dev/null || true
set bundleId to "com.mitchellh.ghostty"

try
  tell application "System Events"
    if not (exists (first process whose bundle identifier is bundleId)) then
      return "not-running"
    end if
    set ghosttyProc to first process whose bundle identifier is bundleId
    set frontmost of ghosttyProc to true
  end tell
on error errMsg number errNum
  return "process-failed:" & errNum
end try

delay 0.12

try
  tell application "System Events"
    set frontProc to first process whose frontmost is true
    if bundle identifier of frontProc is not bundleId then
      return "not-frontmost"
    end if
    -- Key code 43 is the physical comma key. This mirrors Cmd+Shift+,.
    key code 43 using {command down, shift down}
  end tell
  return "ok"
on error errMsg number errNum
  return "keystroke-failed:" & errNum
end try
APPLESCRIPT
)"

  if [[ "$result" == "ok" ]]; then
    return 0
  fi

  if [[ -z "$result" ]]; then
    UNSAFE_RELOAD_REASON="osascript-error"
    return 1
  fi

  case "$result" in
    not-running)
      UNSAFE_RELOAD_REASON="not-running"
      ;;
    check-failed)
      UNSAFE_RELOAD_REASON="check-failed"
      ;;
    process-failed:*|not-frontmost)
      UNSAFE_RELOAD_REASON="$result"
      ;;
    keystroke-failed:*)
      UNSAFE_RELOAD_REASON="$result"
      ;;
    *)
      UNSAFE_RELOAD_REASON="unknown"
      ;;
  esac
  return 1
}

cmd_reload() {
  local option="${1:-}"
  local unsafe=0

  case "$option" in
    ''|safe|--safe)
      ;;
    unsafe|--unsafe|-u)
      unsafe=1
      ;;
    *)
      printf 'Invalid reload option: %s\n' "$option" >&2
      printf 'Usage: boo reload [--unsafe]\n' >&2
      exit 1
      ;;
  esac

  if [[ "${BOO_NO_AUTO_APPLY:-0}" == "1" ]]; then
    printf 'Auto-apply skipped (BOO_NO_AUTO_APPLY=1).\n'
    return 0
  fi

  if (( unsafe == 1 )); then
    if unsafe_reload_via_keystroke; then
      printf 'Triggered Ghostty reload_config via Cmd+Shift+, (unsafe mode).\n'
      printf 'Warning: this can reset active terminals/sessions.\n'
      if [[ "$UNAME_S" == "Darwin" ]]; then
        printf 'On macOS, background-opacity changes require a full Ghostty restart.\n'
      fi
      return 0
    else
      printf 'Unsafe reload unavailable (%s).\n' "${UNSAFE_RELOAD_REASON:-unknown}" >&2
      if [[ "${UNSAFE_RELOAD_REASON:-}" == keystroke-failed:* ]] || [[ "${UNSAFE_RELOAD_REASON:-}" == process-failed:* ]]; then
        printf 'Tip: grant Automation/Accessibility permission for Terminal and System Events.\n' >&2
      elif [[ "${UNSAFE_RELOAD_REASON:-}" == not-frontmost ]]; then
        printf 'Tip: focus Ghostty and run the command again.\n' >&2
      fi
      printf 'No window was opened. Restart/reopen Ghostty manually to apply changes.\n' >&2
      if [[ "$UNAME_S" == "Darwin" ]]; then
        printf 'On macOS, background-opacity changes require a full Ghostty restart.\n' >&2
      fi
      return 1
    fi
  fi

  printf 'Config updated. Safe reload does not open windows or touch running sessions.\n'
  printf 'Restart/reopen Ghostty manually to apply changes.\n'
  if [[ "$UNAME_S" == "Darwin" ]]; then
    printf 'On macOS, background-opacity changes require a full Ghostty restart.\n'
  fi
}

resolve_opacity() {
  local input="$1"
  local resolved

  case "$input" in
    solid)
      printf '1.00\n'
      return
      ;;
    glass)
      printf '0.92\n'
      return
      ;;
    *)
      ;;
  esac

  if [[ ! "$input" =~ ^(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
    printf 'Invalid opacity: %s\n' "$input" >&2
    printf 'Use a value between 0.30 and 1.00, or: glass, solid\n' >&2
    exit 1
  fi

  resolved="$(awk -v n="$input" 'BEGIN {
    if (n + 0 == n && n >= 0.30 && n <= 1.00) {
      printf "%.2f", n
      exit 0
    }
    exit 1
  }')" || {
    printf 'Invalid opacity: %s\n' "$input" >&2
    printf 'Use a value between 0.30 and 1.00, or: glass, solid\n' >&2
    exit 1
  }

  printf '%s\n' "$resolved"
}

apply_theme() {
  local theme="$1"
  local theme_name foreground cursor_color cursor_text selection_bg selection_fg
  local file

  case "$theme" in
    obsidian)
      theme_name="Phala Green Dark"
      foreground="#d8dde5"
      cursor_color="#e8ecf2"
      cursor_text="#000000"
      selection_bg="#262e38"
      selection_fg="#f5f7fb"
      ;;
    graphite)
      theme_name="Phala Green Dark"
      foreground="#e6ebf2"
      cursor_color="#f2f5fa"
      cursor_text="#000000"
      selection_bg="#323a47"
      selection_fg="#ffffff"
      ;;
    lunar)
      theme_name="Phala Green Dark"
      foreground="#d9e2f2"
      cursor_color="#f2f6ff"
      cursor_text="#000000"
      selection_bg="#243247"
      selection_fg="#f8fbff"
      ;;
    crimson)
      theme_name="Phala Green Dark"
      foreground="#ffe4ea"
      cursor_color="#fff3f6"
      cursor_text="#000000"
      selection_bg="#3a121a"
      selection_fg="#fff7fa"
      ;;
    matrix)
      theme_name="Phala Green Dark"
      foreground="#caffd0"
      cursor_color="#eaffef"
      cursor_text="#000000"
      selection_bg="#103018"
      selection_fg="#f1fff3"
      ;;
    *)
      printf 'Invalid theme: %s\n' "$theme" >&2
      printf 'Use: obsidian, graphite, lunar, crimson, matrix\n' >&2
      exit 1
      ;;
  esac

  collect_ghostty_targets
  for file in "${ghostty_targets[@]}"; do
    upsert_key "$file" "theme" "$theme_name"
    upsert_key "$file" "foreground" "$foreground"
    upsert_key "$file" "cursor-color" "$cursor_color"
    upsert_key "$file" "cursor-text" "$cursor_text"
    upsert_key "$file" "selection-background" "$selection_bg"
    upsert_key "$file" "selection-foreground" "$selection_fg"
    replace_palette_lines "$file" "$theme"
  done

  apply_prompt_theme "$theme" || true
  write_theme_env_file "$theme"
  write_theme_file "$theme"
}

cmd_mode() {
  local arg="${1:-}"

  case "$arg" in
    '')
      printf 'Current mode: %s\n' "$(read_mode)"
      printf 'Usage: boo mode [full|public]\n'
      ;;
    full|private|1)
      write_mode_file "1"
      printf 'Boo mode set to: full\n'
      print_shell_apply_hint
      ;;
    public|safe|0)
      write_mode_file "0"
      printf 'Boo mode set to: public\n'
      print_shell_apply_hint
      ;;
    *)
      printf 'Invalid mode: %s\n' "$arg" >&2
      printf 'Usage: boo mode [full|public]\n' >&2
      exit 1
      ;;
  esac
}

cmd_prompt() {
  local action="${1:-}"
  local backend="${2:-}"
  local configured effective

  case "$action" in
    ''|show|status)
      configured="$(read_prompt_backend)"
      effective="$(effective_prompt_backend)"
      printf 'Prompt backend (configured): %s\n' "$configured"
      printf 'Prompt backend (active): %s\n' "$effective"
      if [[ "$configured" == "omp" && "$effective" == "native" ]]; then
        printf 'oh-my-posh is missing; Boo is using native prompt fallback.\n'
      fi
      printf 'Usage: boo prompt [show|list|set <native|omp>|native|omp]\n'
      ;;
    list)
      cat <<'EOF'
Available prompt backends:
  native  - Built-in zsh prompt (no external dependency)
  omp     - oh-my-posh prompt engine
EOF
      ;;
    set)
      if [[ -z "$backend" ]]; then
        printf 'Usage: boo prompt set <native|omp>\n' >&2
        exit 1
      fi
      case "$backend" in
        native|omp)
          write_prompt_backend "$backend"
          printf 'Boo prompt backend set to: %s\n' "$backend"
          if [[ "$backend" == "omp" ]] && ! command -v oh-my-posh >/dev/null 2>&1; then
            printf 'oh-my-posh not found; shell will fall back to native until it is installed.\n'
          fi
          print_shell_apply_hint
          ;;
        *)
          printf 'Invalid prompt backend: %s\n' "$backend" >&2
          printf 'Use: native, omp\n' >&2
          exit 1
          ;;
      esac
      ;;
    native|omp)
      write_prompt_backend "$action"
      printf 'Boo prompt backend set to: %s\n' "$action"
      if [[ "$action" == "omp" ]] && ! command -v oh-my-posh >/dev/null 2>&1; then
        printf 'oh-my-posh not found; shell will fall back to native until it is installed.\n'
      fi
      print_shell_apply_hint
      ;;
    *)
      printf 'Invalid prompt command: %s\n' "$action" >&2
      printf 'Usage: boo prompt [show|list|set <native|omp>|native|omp]\n' >&2
      exit 1
      ;;
  esac
}

cmd_theme() {
  local action="${1:-}"
  local theme="${2:-}"

  case "$action" in
    '')
      printf 'Current theme: %s\n' "$(read_theme_file)"
      printf 'Usage: boo theme [list|set <name>|<name>]\n'
      ;;
    list)
      cat <<'EOF'
Available themes:
  obsidian  - Original Boo palette + purple accents
  graphite  - Neutral gray + violet accents
  lunar     - Cool blue-gray, no purple accents
  crimson   - High-contrast red assault mode
  matrix    - Aggressive hacker-green mode
EOF
      ;;
    set)
      if [[ -z "$theme" ]]; then
        printf 'Usage: boo theme set <obsidian|graphite|lunar|crimson|matrix>\n' >&2
        exit 1
      fi
      apply_theme "$theme"
      printf 'Boo theme set to: %s\n' "$theme"
      printf 'Prompt + syntax accents updated.\n'
      print_shell_apply_hint
      cmd_reload || true
      ;;
    obsidian|graphite|lunar|crimson|matrix)
      apply_theme "$action"
      printf 'Boo theme set to: %s\n' "$action"
      printf 'Prompt + syntax accents updated.\n'
      print_shell_apply_hint
      cmd_reload || true
      ;;
    *)
      printf 'Invalid theme command: %s\n' "$action" >&2
      printf 'Usage: boo theme [list|set <name>|<name>]\n' >&2
      exit 1
      ;;
  esac
}

cmd_opacity() {
  local arg="${1:-}"
  local resolved

  case "$arg" in
    '')
      printf 'Current opacity: %s\n' "$(current_opacity)"
      printf 'Usage: boo opacity [value|glass|solid]\n'
      ;;
    *)
      resolved="$(resolve_opacity "$arg")"
      set_opacity_value "$resolved"
      printf 'Background opacity set to: %s\n' "$resolved"
      cmd_reload --unsafe || true
      ;;
  esac
}

cmd_preview() {
  local target=""
  local token
  local plain=0
  local themes=(obsidian graphite lunar crimson matrix)
  local theme

  for token in "$@"; do
    case "$token" in
      '' )
        ;;
      --plain|-p)
        plain=1
        ;;
      obsidian|graphite|lunar|crimson|matrix|all)
        if [[ -n "$target" ]]; then
          printf 'Only one preview target can be used at a time.\n' >&2
          printf 'Usage: boo preview <obsidian|graphite|lunar|crimson|matrix|all> [--plain]\n' >&2
          exit 1
        fi
        target="$token"
        ;;
      *)
        printf 'Invalid preview option/target: %s\n' "$token" >&2
        printf 'Usage: boo preview <obsidian|graphite|lunar|crimson|matrix|all> [--plain]\n' >&2
        exit 1
        ;;
    esac
  done

  if [[ -z "$target" ]]; then
    printf 'Usage: boo preview <obsidian|graphite|lunar|crimson|matrix|all> [--plain]\n'
    return
  fi

  case "$target" in
    all)
      if (( plain == 1 )); then
        printf 'Legend: bg fg accent cursor selection (hex)\n\n'
      else
        printf 'Legend: bg fg accent cursor selection\n\n'
      fi
      for theme in "${themes[@]}"; do
        print_preview_all_row "$theme" "$plain"
      done
      ;;
    *)
      print_theme_preview "$target" "$plain"
      ;;
  esac
}

cmd_splash() {
  local action="${1:-}"
  local arg="${2:-}"
  local splash

  case "$action" in
    ''|show|status)
      splash="$(read_splash_name)"
      printf 'Current splash: %s\n' "$splash"
      printf 'Usage: boo splash [list|<name>|custom <file>|none|reset]\n'
      ;;
    list)
      printf 'Available splash art:\n'
      while IFS= read -r splash; do
        printf '\n- %s\n' "$splash"
        print_splash_preview "$splash"
      done < <(list_splash_names)
      ;;
    custom)
      if [[ -z "$arg" ]]; then
        printf 'Usage: boo splash custom <file>\n' >&2
        exit 1
      fi
      if [[ ! -f "$arg" ]]; then
        printf 'Custom splash file not found: %s\n' "$arg" >&2
        exit 1
      fi
      mkdir -p "$(dirname "$CUSTOM_SPLASH_FILE")"
      cp "$arg" "$CUSTOM_SPLASH_FILE"
      write_splash_name "custom"
      printf 'Splash set to custom: %s\n' "$CUSTOM_SPLASH_FILE"
      print_shell_apply_hint
      ;;
    none)
      write_splash_name "none"
      printf 'Startup panel disabled.\n'
      print_shell_apply_hint
      ;;
    reset)
      write_splash_name "$DEFAULT_SPLASH"
      printf 'Splash reset to default: %s\n' "$DEFAULT_SPLASH"
      print_shell_apply_hint
      ;;
    apple|ghost|skull|cat|minimal|boo)
      write_splash_name "$action"
      printf 'Splash set to: %s\n' "$action"
      print_shell_apply_hint
      ;;
    *)
      printf 'Invalid splash option: %s\n' "$action" >&2
      printf 'Usage: boo splash [list|<name>|custom <file>|none|reset]\n' >&2
      exit 1
      ;;
  esac
}

cmd_doctor() {
  local action="${1:-check}"

  case "$action" in
    ''|check|status)
      if doctor_run_checks; then
        return 0
      fi
      printf '\nSome checks failed. Run `boo doctor fix` and then `exec zsh`.\n' >&2
      return 1
      ;;
    fix|--fix)
      doctor_apply_fixes
      printf '\nRe-running checks after fixes...\n\n'
      if doctor_run_checks; then
        printf '\nDoctor finished. For shell changes, run `exec zsh`.\n'
        return 0
      fi
      printf '\nDoctor applied fixes but some checks still failed.\n' >&2
      return 1
      ;;
    *)
      printf 'Invalid doctor action: %s\n' "$action" >&2
      printf 'Usage: boo doctor [check|fix]\n' >&2
      exit 1
      ;;
  esac
}

cmd_status() {
  local mode
  mode="$(read_mode)"
  local theme accent
  theme="$(read_theme_file)"
  accent="$(theme_accent_color "$theme")"
  collect_ghostty_targets
  printf 'mode: %s\n' "$mode"
  printf 'theme: %s\n' "$theme"
  printf 'accent: %s\n' "$accent"
  printf 'prompt_backend: %s\n' "$(read_prompt_backend)"
  printf 'prompt_backend_effective: %s\n' "$(effective_prompt_backend)"
  printf 'splash: %s\n' "$(read_splash_name)"
  printf 'opacity: %s\n' "$(current_opacity)"
  printf 'mode_file: %s\n' "$MODE_FILE"
  if [[ -f "$MODE_FILE" ]]; then
    printf 'mode_file_exists: yes\n'
  else
    printf 'mode_file_exists: no\n'
  fi
  printf 'theme_file: %s\n' "$THEME_FILE"
  if [[ -f "$THEME_FILE" ]]; then
    printf 'theme_file_exists: yes\n'
  else
    printf 'theme_file_exists: no\n'
  fi
  printf 'ghostty_config_count: %s\n' "${#ghostty_targets[@]}"
  local file
  for file in "${ghostty_targets[@]}"; do
    printf 'ghostty_config: %s\n' "$file"
  done
}

subcommand="${1:-help}"
case "$subcommand" in
  mode)
    shift || true
    cmd_mode "${1:-}"
    ;;
  theme)
    shift || true
    cmd_theme "${1:-}" "${2:-}"
    ;;
  prompt)
    shift || true
    cmd_prompt "${1:-}" "${2:-}"
    ;;
  obsidian|graphite|lunar|crimson|matrix)
    cmd_theme "$subcommand"
    ;;
  opacity)
    shift || true
    cmd_opacity "${1:-}"
    ;;
  reload)
    shift || true
    cmd_reload "${1:-}"
    ;;
  preview)
    shift || true
    cmd_preview "$@"
    ;;
  splash)
    shift || true
    cmd_splash "${1:-}" "${2:-}"
    ;;
  doctor)
    shift || true
    cmd_doctor "${1:-}"
    ;;
  status)
    cmd_status
    ;;
  help|-h|--help)
    print_help
    ;;
  *)
    printf 'Unknown command: %s\n\n' "$subcommand" >&2
    print_help >&2
    exit 1
    ;;
esac
