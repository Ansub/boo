#!/usr/bin/env bash
set -euo pipefail

MODE_FILE="${HOME}/.config/obsighost/mode.zsh"
THEME_FILE="${HOME}/.config/obsighost/theme"
GHOSTTY_CONFIG_PRIMARY="${HOME}/.config/ghostty/config"
GHOSTTY_CONFIG_MAC="${HOME}/Library/Application Support/com.mitchellh.ghostty/config"
DEFAULT_OPACITY="0.92"
DEFAULT_THEME="obsidian"
UNAME_S="$(uname -s)"
UNSAFE_RELOAD_REASON=""

ghostty_targets=()

print_help() {
  cat <<'EOF'
ObsiGhost CLI

Usage:
  obsighost mode [full|public]
  obsighost theme [list|set <name>|<name>]
  obsighost opacity [value|glass|solid]
  obsighost reload [--unsafe]
  obsighost status
  obsighost help

Commands:
  mode       Show or set startup panel mode.
  theme      List or apply theme presets.
  opacity    Show or set Ghostty background opacity.
  reload     No new windows. Use --unsafe to send Cmd+Shift+, to Ghostty.
  status     Print current mode/theme/opacity.
  help       Show this help message.
EOF
}

read_mode() {
  if [[ -f "$MODE_FILE" ]]; then
    if grep -q 'OBSIGHOST_SHOW_PRIVATE=0' "$MODE_FILE"; then
      printf 'public\n'
      return
    fi
    if grep -q 'OBSIGHOST_SHOW_PRIVATE=1' "$MODE_FILE"; then
      printf 'full\n'
      return
    fi
  fi
  if [[ "${OBSIGHOST_SHOW_PRIVATE:-}" == "0" ]]; then
    printf 'public\n'
  else
    printf 'full\n'
  fi
}

write_mode_file() {
  local value="$1"
  mkdir -p "$(dirname "$MODE_FILE")"
  printf 'export OBSIGHOST_SHOW_PRIVATE=%s\n' "$value" > "$MODE_FILE"
}

read_theme_file() {
  local theme
  if [[ -f "$THEME_FILE" ]]; then
    theme="$(tr -d '[:space:]' < "$THEME_FILE")"
    if [[ -n "$theme" ]]; then
      printf '%s\n' "$theme"
      return
    fi
  fi
  printf '%s\n' "$DEFAULT_THEME"
}

write_theme_file() {
  local theme="$1"
  mkdir -p "$(dirname "$THEME_FILE")"
  printf '%s\n' "$theme" > "$THEME_FILE"
}

collect_ghostty_targets() {
  ghostty_targets=()

  if [[ "$UNAME_S" == "Darwin" ]]; then
    # Prefer whichever config Ghostty is already using (non-empty file).
    if [[ -s "$GHOSTTY_CONFIG_MAC" ]]; then
      ghostty_targets+=("$GHOSTTY_CONFIG_MAC")
    fi
    if [[ -s "$GHOSTTY_CONFIG_PRIMARY" ]]; then
      ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
    fi

    if [[ "${#ghostty_targets[@]}" -eq 0 ]]; then
      if [[ -f "$GHOSTTY_CONFIG_MAC" ]]; then
        ghostty_targets+=("$GHOSTTY_CONFIG_MAC")
      elif [[ -f "$GHOSTTY_CONFIG_PRIMARY" ]]; then
        ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
      else
        mkdir -p "$(dirname "$GHOSTTY_CONFIG_PRIMARY")"
        touch "$GHOSTTY_CONFIG_PRIMARY"
        ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
      fi
    fi
    return
  fi

  mkdir -p "$(dirname "$GHOSTTY_CONFIG_PRIMARY")"
  if [[ ! -f "$GHOSTTY_CONFIG_PRIMARY" ]]; then
    touch "$GHOSTTY_CONFIG_PRIMARY"
  fi
  ghostty_targets+=("$GHOSTTY_CONFIG_PRIMARY")
}

upsert_key() {
  local file="$1"
  local key="$2"
  local value="$3"
  local tmp
  tmp="$(mktemp)"

  awk -v key="$key" -v value="$value" '
    BEGIN { re = "^[[:space:]]*" key "[[:space:]]*="; done = 0 }
    $0 ~ re {
      if (!done) {
        print key " = " value
        done = 1
      }
      next
    }
    { print }
    END {
      if (!done) {
        print key " = " value
      }
    }
  ' "$file" > "$tmp"

  mv "$tmp" "$file"
}

theme_palette_lines() {
  local theme="$1"
  case "$theme" in
    obsidian)
      cat <<'EOF'
palette = 0=#0b0f0b
palette = 1=#7a3b3b
palette = 2=#6fb56f
palette = 3=#a9a062
palette = 4=#5f7da3
palette = 5=#8b76a8
palette = 6=#5ea39a
palette = 7=#a8bfa8
palette = 8=#2a342a
palette = 9=#b35757
palette = 10=#8fdb8f
palette = 11=#d1c97b
palette = 12=#7ea4d1
palette = 13=#ac93cb
palette = 14=#7dc7be
palette = 15=#d9ead9
EOF
      ;;
    graphite)
      cat <<'EOF'
palette = 0=#0f1115
palette = 1=#6e7a88
palette = 2=#8493a5
palette = 3=#9ba8b8
palette = 4=#8f9fb3
palette = 5=#a882ff
palette = 6=#8caeb5
palette = 7=#d7dde7
palette = 8=#252a33
palette = 9=#7f8ea1
palette = 10=#97a8bd
palette = 11=#b2becd
palette = 12=#a2b2c8
palette = 13=#bba2ff
palette = 14=#a2c3c8
palette = 15=#f2f5f9
EOF
      ;;
    lunar)
      cat <<'EOF'
palette = 0=#0a0f18
palette = 1=#5f6f92
palette = 2=#6f86aa
palette = 3=#8c9ec0
palette = 4=#7891b7
palette = 5=#a882ff
palette = 6=#7ca9bb
palette = 7=#ced8e8
palette = 8=#1f2938
palette = 9=#7085ab
palette = 10=#83a0c2
palette = 11=#9fb4d0
palette = 12=#8ea8cc
palette = 13=#b89eff
palette = 14=#95c3cf
palette = 15=#eff4ff
EOF
      ;;
    *)
      return 1
      ;;
  esac
}

replace_palette_lines() {
  local file="$1"
  local theme="$2"
  local tmp palette_tmp

  tmp="$(mktemp)"
  palette_tmp="$(mktemp)"
  theme_palette_lines "$theme" > "$palette_tmp"

  awk -v palette_file="$palette_tmp" '
    BEGIN { inserted = 0 }
    /^[[:space:]]*palette[[:space:]]*=/ { next }
    {
      print
      if (!inserted && $0 ~ /^[[:space:]]*selection-foreground[[:space:]]*=/) {
        while ((getline line < palette_file) > 0) {
          print line
        }
        close(palette_file)
        inserted = 1
      }
    }
    END {
      if (!inserted) {
        while ((getline line < palette_file) > 0) {
          print line
        }
        close(palette_file)
      }
    }
  ' "$file" > "$tmp"

  mv "$tmp" "$file"
  rm -f "$palette_tmp"
}

current_opacity() {
  collect_ghostty_targets
  local file line value
  for file in "${ghostty_targets[@]}"; do
    line="$(grep -m1 -E '^[[:space:]]*background-opacity[[:space:]]*=' "$file" || true)"
    if [[ -n "$line" ]]; then
      value="$(printf '%s\n' "$line" | sed -E 's/^[^=]+= *//; s/[[:space:]]+$//')"
      printf '%s\n' "$value"
      return
    fi
  done
  printf '%s\n' "$DEFAULT_OPACITY"
}

set_opacity_value() {
  local value="$1"
  local file

  collect_ghostty_targets
  for file in "${ghostty_targets[@]}"; do
    upsert_key "$file" "background-opacity" "$value"
  done
}

unsafe_reload_via_keystroke() {
  local result
  UNSAFE_RELOAD_REASON=""

  if [[ "$UNAME_S" != "Darwin" ]]; then
    UNSAFE_RELOAD_REASON="not-darwin"
    return 1
  fi
  if ! command -v osascript >/dev/null 2>&1; then
    UNSAFE_RELOAD_REASON="no-osascript"
    return 1
  fi

  result="$(osascript <<'APPLESCRIPT' 2>/dev/null || true
set bundleId to "com.mitchellh.ghostty"

try
  tell application "System Events"
    if not (exists (first process whose bundle identifier is bundleId)) then
      return "not-running"
    end if
    set ghosttyProc to first process whose bundle identifier is bundleId
    set frontmost of ghosttyProc to true
  end tell
on error errMsg number errNum
  return "process-failed:" & errNum
end try

delay 0.12

try
  tell application "System Events"
    set frontProc to first process whose frontmost is true
    if bundle identifier of frontProc is not bundleId then
      return "not-frontmost"
    end if
    -- Key code 43 is the physical comma key. This mirrors Cmd+Shift+,.
    key code 43 using {command down, shift down}
  end tell
  return "ok"
on error errMsg number errNum
  return "keystroke-failed:" & errNum
end try
APPLESCRIPT
)"

  if [[ "$result" == "ok" ]]; then
    return 0
  fi

  if [[ -z "$result" ]]; then
    UNSAFE_RELOAD_REASON="osascript-error"
    return 1
  fi

  case "$result" in
    not-running)
      UNSAFE_RELOAD_REASON="not-running"
      ;;
    check-failed)
      UNSAFE_RELOAD_REASON="check-failed"
      ;;
    process-failed:*|not-frontmost)
      UNSAFE_RELOAD_REASON="$result"
      ;;
    keystroke-failed:*)
      UNSAFE_RELOAD_REASON="$result"
      ;;
    *)
      UNSAFE_RELOAD_REASON="unknown"
      ;;
  esac
  return 1
}

cmd_reload() {
  local option="${1:-}"
  local unsafe=0

  case "$option" in
    ''|safe|--safe)
      ;;
    unsafe|--unsafe|-u)
      unsafe=1
      ;;
    *)
      printf 'Invalid reload option: %s\n' "$option" >&2
      printf 'Usage: obsighost reload [--unsafe]\n' >&2
      exit 1
      ;;
  esac

  if [[ "${OBSIGHOST_NO_AUTO_APPLY:-0}" == "1" ]]; then
    printf 'Auto-apply skipped (OBSIGHOST_NO_AUTO_APPLY=1).\n'
    return 0
  fi

  if (( unsafe == 1 )); then
    if unsafe_reload_via_keystroke; then
      printf 'Triggered Ghostty reload_config via Cmd+Shift+, (unsafe mode).\n'
      printf 'Warning: this can reset active terminals/sessions.\n'
      if [[ "$UNAME_S" == "Darwin" ]]; then
        printf 'On macOS, background-opacity changes require a full Ghostty restart.\n'
      fi
      return 0
    else
      printf 'Unsafe reload unavailable (%s).\n' "${UNSAFE_RELOAD_REASON:-unknown}" >&2
      if [[ "${UNSAFE_RELOAD_REASON:-}" == keystroke-failed:* ]] || [[ "${UNSAFE_RELOAD_REASON:-}" == process-failed:* ]]; then
        printf 'Tip: grant Automation/Accessibility permission for Terminal and System Events.\n' >&2
      elif [[ "${UNSAFE_RELOAD_REASON:-}" == not-frontmost ]]; then
        printf 'Tip: focus Ghostty and run the command again.\n' >&2
      fi
      printf 'No window was opened. Restart/reopen Ghostty manually to apply changes.\n' >&2
      if [[ "$UNAME_S" == "Darwin" ]]; then
        printf 'On macOS, background-opacity changes require a full Ghostty restart.\n' >&2
      fi
      return 1
    fi
  fi

  printf 'Config updated. Safe reload does not open windows or touch running sessions.\n'
  printf 'Restart/reopen Ghostty manually to apply changes.\n'
  if [[ "$UNAME_S" == "Darwin" ]]; then
    printf 'On macOS, background-opacity changes require a full Ghostty restart.\n'
  fi
}

resolve_opacity() {
  local input="$1"
  local resolved

  case "$input" in
    solid)
      printf '1.00\n'
      return
      ;;
    glass)
      printf '0.92\n'
      return
      ;;
    *)
      ;;
  esac

  if [[ ! "$input" =~ ^(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
    printf 'Invalid opacity: %s\n' "$input" >&2
    printf 'Use a value between 0.30 and 1.00, or: glass, solid\n' >&2
    exit 1
  fi

  resolved="$(awk -v n="$input" 'BEGIN {
    if (n + 0 == n && n >= 0.30 && n <= 1.00) {
      printf "%.2f", n
      exit 0
    }
    exit 1
  }')" || {
    printf 'Invalid opacity: %s\n' "$input" >&2
    printf 'Use a value between 0.30 and 1.00, or: glass, solid\n' >&2
    exit 1
  }

  printf '%s\n' "$resolved"
}

apply_theme() {
  local theme="$1"
  local theme_name foreground cursor_color cursor_text selection_bg selection_fg
  local file

  case "$theme" in
    obsidian)
      theme_name="Phala Green Dark"
      foreground="#d8dde5"
      cursor_color="#e8ecf2"
      cursor_text="#000000"
      selection_bg="#262e38"
      selection_fg="#f5f7fb"
      ;;
    graphite)
      theme_name="Phala Green Dark"
      foreground="#e6ebf2"
      cursor_color="#f2f5fa"
      cursor_text="#000000"
      selection_bg="#323a47"
      selection_fg="#ffffff"
      ;;
    lunar)
      theme_name="Phala Green Dark"
      foreground="#d9e2f2"
      cursor_color="#f2f6ff"
      cursor_text="#000000"
      selection_bg="#243247"
      selection_fg="#f8fbff"
      ;;
    *)
      printf 'Invalid theme: %s\n' "$theme" >&2
      printf 'Use: obsidian, graphite, lunar\n' >&2
      exit 1
      ;;
  esac

  collect_ghostty_targets
  for file in "${ghostty_targets[@]}"; do
    upsert_key "$file" "theme" "$theme_name"
    upsert_key "$file" "foreground" "$foreground"
    upsert_key "$file" "cursor-color" "$cursor_color"
    upsert_key "$file" "cursor-text" "$cursor_text"
    upsert_key "$file" "selection-background" "$selection_bg"
    upsert_key "$file" "selection-foreground" "$selection_fg"
    replace_palette_lines "$file" "$theme"
  done

  write_theme_file "$theme"
}

cmd_mode() {
  local arg="${1:-}"

  case "$arg" in
    '')
      printf 'Current mode: %s\n' "$(read_mode)"
      printf 'Usage: obsighost mode [full|public]\n'
      ;;
    full|private|1)
      write_mode_file "1"
      printf 'ObsiGhost mode set to: full\n'
      printf 'Apply now: source ~/.zshrc\n'
      ;;
    public|safe|0)
      write_mode_file "0"
      printf 'ObsiGhost mode set to: public\n'
      printf 'Apply now: source ~/.zshrc\n'
      ;;
    *)
      printf 'Invalid mode: %s\n' "$arg" >&2
      printf 'Usage: obsighost mode [full|public]\n' >&2
      exit 1
      ;;
  esac
}

cmd_theme() {
  local action="${1:-}"
  local theme="${2:-}"

  case "$action" in
    '')
      printf 'Current theme: %s\n' "$(read_theme_file)"
      printf 'Usage: obsighost theme [list|set <name>|<name>]\n'
      ;;
    list)
      cat <<'EOF'
Available themes:
  obsidian  - Original ObsiGhost palette
  graphite  - Neutral gray + violet accents
  lunar     - Cool blue-gray + violet accents
EOF
      ;;
    set)
      if [[ -z "$theme" ]]; then
        printf 'Usage: obsighost theme set <obsidian|graphite|lunar>\n' >&2
        exit 1
      fi
      apply_theme "$theme"
      printf 'ObsiGhost theme set to: %s\n' "$theme"
      cmd_reload || true
      ;;
    obsidian|graphite|lunar)
      apply_theme "$action"
      printf 'ObsiGhost theme set to: %s\n' "$action"
      cmd_reload || true
      ;;
    *)
      printf 'Invalid theme command: %s\n' "$action" >&2
      printf 'Usage: obsighost theme [list|set <name>|<name>]\n' >&2
      exit 1
      ;;
  esac
}

cmd_opacity() {
  local arg="${1:-}"
  local resolved

  case "$arg" in
    '')
      printf 'Current opacity: %s\n' "$(current_opacity)"
      printf 'Usage: obsighost opacity [value|glass|solid]\n'
      ;;
    *)
      resolved="$(resolve_opacity "$arg")"
      set_opacity_value "$resolved"
      printf 'Background opacity set to: %s\n' "$resolved"
      cmd_reload || true
      ;;
  esac
}

cmd_status() {
  local mode
  mode="$(read_mode)"
  collect_ghostty_targets
  printf 'mode: %s\n' "$mode"
  printf 'theme: %s\n' "$(read_theme_file)"
  printf 'opacity: %s\n' "$(current_opacity)"
  printf 'mode_file: %s\n' "$MODE_FILE"
  if [[ -f "$MODE_FILE" ]]; then
    printf 'mode_file_exists: yes\n'
  else
    printf 'mode_file_exists: no\n'
  fi
  printf 'theme_file: %s\n' "$THEME_FILE"
  if [[ -f "$THEME_FILE" ]]; then
    printf 'theme_file_exists: yes\n'
  else
    printf 'theme_file_exists: no\n'
  fi
  printf 'ghostty_config_count: %s\n' "${#ghostty_targets[@]}"
  local file
  for file in "${ghostty_targets[@]}"; do
    printf 'ghostty_config: %s\n' "$file"
  done
}

subcommand="${1:-help}"
case "$subcommand" in
  mode)
    shift || true
    cmd_mode "${1:-}"
    ;;
  theme)
    shift || true
    cmd_theme "${1:-}" "${2:-}"
    ;;
  opacity)
    shift || true
    cmd_opacity "${1:-}"
    ;;
  reload)
    shift || true
    cmd_reload "${1:-}"
    ;;
  status)
    cmd_status
    ;;
  help|-h|--help)
    print_help
    ;;
  *)
    printf 'Unknown command: %s\n\n' "$subcommand" >&2
    print_help >&2
    exit 1
    ;;
esac
